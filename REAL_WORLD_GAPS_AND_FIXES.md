# Tired App 真實情境邏輯修正與缺漏功能設計

本文聚焦於「真實使用情境」下的邏輯修正與仍缺失的能力設計，便於後續開發落地。

## 已修正的關鍵邏輯

- **任務完成權限符合真實角色**  
  - 位置：`ViewModels/TasksViewModel.swift`  
  - 原本僅允許具備高階組織權限的用戶標記/編輯/刪除任務，實際上最常見的是「任務作者或被指派者」需要處理。  
  - 調整：作者/被指派者可直接操作；具備 `manageAllOrgTasks` / `editAnyTaskInOrg` / `deleteAnyTaskInOrg` 等管理權限者也可操作；評論刪除遵循「任務作者或評論作者」優先，並尊重 `deleteAnyTaskCommentInOrg` / `deleteOwnTaskComment`。  
  - 成果：組織內的任務不再被權限誤鎖，符合實際協作流程。

- **自動排程尊重依賴與優先級**  
  - 位置：`Utils/AutoPlanService.swift`、`Services/TaskDependencyService.swift`  
  - 原本自動排程僅按優先級/截止日排序，可能把有前置條件的任務排到其依賴之前。  
  - 調整：加入優先級導向的拓撲排序，先排所有依賴已滿足的任務，同時在可排隊列內仍按「優先級 → 截止日 → 建立時間」取最高優先。  
  - 成果：排程順序符合實際工作流，不會出現「先做子任務再做父任務」的矛盾。

## 真實情境下仍缺的功能與設計

### 1) 跨身份/行程的衝突檢測與解決
- **痛點**：學生/實習生/社團等多重身份下，任務或會議時間容易重疊，現有系統只有日容量判斷，沒有「具體時間段」的衝突提示。
- **邏輯設計**：
  - 模型：新增 `TaskConflict`，含衝突任務列表、時間範圍、嚴重度；利用 `plannedStartTime + estimatedMinutes` 推導事件區間。
  - 檢測：在排程/手動改期時，對同日任務做區間重疊判斷；外部行事曆 Busy Block 亦納入。
  - 解決策略：給出三種自動建議——「向前移動」、「向後推遲」、「拆分到多日」，並標記被動到的任務清單。
- **UI/回饋**：在 Today/Week 頁面顯示衝突條；點擊可展開衝突對象與一鍵採用建議。

### 2) 緊急任務插隊與影響提示
- **痛點**：臨時插入高優先的緊急任務時，使用者需要知道「哪些原定任務被擠掉」。
- **邏輯設計**：
  - 流程：建立/接收緊急任務 → 標記為 `urgent=true` → 自動排程以「最早可行時間」插入 → 產出「被移動任務列表」。
  - 模型：新增 `RescheduleImpact`（被移動任務 ID、原日期、新日期、延後天數、是否逾期風險）。
  - 規則：被移動任務若離截止 <48h，需額外標記「高風險」並要求確認。
- **UI/回饋**：插入完成後彈出「本次插入導致 X 個任務移動」，可查看詳細並一鍵撤銷。

### 3) 離線/弱網工作的安全網
- **痛點**：通勤或校園環境常處於弱網，當前 App 依賴即時 Firestore，易出現操作丟失或回饋延遲。
- **邏輯設計**：
  - 本地緩存：使用 SwiftData/CoreData 緩存任務與操作隊列（create/update/delete），每個操作帶 `pendingSyncId`。
  - 同步策略：網路恢復後按時間順序重放；若衝突（遠端已更新），提供「以遠端為準 / 以本地覆蓋 / 合併欄位」三選。
  - 狀態提示：頂部橫幅顯示「離線狀態」；操作結果先本地預提交並顯示「待同步」徽章。
- **監控**：記錄最後成功同步時間，超過 24h 主動提示用戶檢查同步狀態。

### 4) 身份化容量與專注時段
- **痛點**：多身份使用者希望「公司任務只能排在 9-18，社團任務排晚上」，現有排程只看週/日容量。
- **邏輯設計**：
  - 模型：新增 `IdentitySchedulePreference`（organizationId/roleId、可用星期、可用時段、每日上限分鐘）。
  - 排程：自動排程時先匹配身份可用時段；若無可用時段，回傳「需跨身份或調整容量」提示。
  - 專注時段：支持設定「深度工作時段」類型，僅允許高優先任務進入。
- **UI**：身份偏好設定頁；排程後的任務卡片顯示所用的身份規則來源。

### 5) 截止前提醒策略升級
- **痛點**：提醒僅在單一時間點觸發，不足以應對長任務或多人協作。
- **設計**：
  - 分段提醒：按剩餘時間自動生成 T-24h、T-4h、T-30m；對長任務（估時>180m）在開始時再提醒一次。
  - 團隊任務：若任務逾期，通知作者與所有 assignee；若 assignee 仍未讀，24h 後再提醒一次。
  - 消噪：同日多次提醒將合併摘要，避免通知轟炸。

---

落地建議：先實作「衝突檢測 + 緊急插隊」與「離線安全網」，可以顯著提升真實場景下的可靠度；身份化容量與提醒升級可在第二階段迭代。
